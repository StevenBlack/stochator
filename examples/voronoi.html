<!DOCTYPE html>
<html>
  <head>
    <link type="text/css" rel="stylesheet" href="lib/d3.styles.css"/>
    <style type="text/css">

      html, body {
        width: 100%;
      }

      svg#diagram {
        border: 1px brown solid;
        margin: 0 auto;
      }

      path.cell {
        fill: none;
        pointer-events: all;
        stroke: brown;
      }

      path.link {
        fill: none;
        stroke: blue;
      }

      circle {
        fill: black;
      }

    </style>
  </head>
  <body>
    <script type="text/javascript" src="../build/stochator.js"></script>
    <script type="text/javascript" src="lib/d3.js"></script>
    <script type="text/javascript" src="lib/d3.geo.js"></script>
    <script type="text/javascript" src="lib/d3.geom.js"></script>
    <script type="text/javascript">

        var colorPolygon = function(polygon) {
            var areaRatio = polygon.area() / 1024000;
            var color = Math.floor(areaRatio * 255);

        };

        var initializeSvg = function(width, height) {
            return d3.select("body").insert("svg:svg", "h2")
                .attr("id", "diagram")
                .attr("width", width)
                .attr("height", height);
        };

        var initializeCells = function(svg) {
            return svg.append("svg:g")
                .attr("id", "cells");
        };

        var generatePositions = function(maxX, maxY, number) {
            var xOrd = { min: 0, max: maxX, kind: 'integer' };
            var yOrd = { min: 0, max: maxY, kind: 'integer' };
            var pointGenerator = new Stochator(xOrd, yOrd);
            return d3.range(number).map(function() {
                return pointGenerator.next();
            });
        };

        var movePositions = function(positions, width, height) {
            var changeX = { min: -10, max: 10, mean: 0, stdev: 2 };
            var changeY = { min: -5, max: 5,  mean: 0, stdev: 1 };
            var changeGenerator = new Stochator(changeX, changeY);
            positions.map(function(position) {
                var change = changeGenerator.next();
                position[0] = position[0] + change[0] % width;
                position[1] = position[1] + change[1] % height;
                return position;
            });
            return positions;
        };

        var drawDiagram = function(svg, positions, width, height) {
            // Compute the Voronoi diagram of the random points.

            var cells = initializeCells(svg);
            var polygons = d3.geom.voronoi(positions);

            var g = cells.selectAll("g")
                .data(positions)
                .enter().append("svg:g");

            var paths = g.append("svg:path")
                .attr("class", "cell")
                .attr("d", function(d, i) { return "M" + polygons[i].join("L") + "Z"; });

            var circles = g.append("svg:circle")
                .attr("cx", function(d, i) { return positions[i][0]; })
                .attr("cy", function(d, i) { return positions[i][1]; })
                .attr("r", 1.5);

            var links = svg.append("svg:g")
                .attr("id", "links");

            var connections = [];
            d3.geom.delaunay(positions).forEach(function(d) {
                connections.push(edge(d[0], d[1]));
                connections.push(edge(d[1], d[2]));
                connections.push(edge(d[2], d[0]));
            });

            var lg = links.selectAll("g")
                .data(connections)
                .enter().append("svg:g");

            var linkPaths = lg.append("svg:path")
                .attr("class", "link")
                .attr("x1", function(d) { return d.source[0]; })
                .attr("y1", function(d) { return d.target[0]; })
                .attr("x2", function(d) { return d.source[1]; })
                .attr("y2", function(d) { return d.target[1]; });

            // var paths = g.append("svg:path")
            //     .attr("d", function )


            // links = links.map(function(link) {
            //     return [ link.source, link.target ];
            // });

            return { paths: paths, circles: circles };
        };

        var edge = function(a, b) {
            return {
                source: a,
                target: b
            };
        };

        var width = 640, height = 400;
        var svg = initializeSvg(width, height);
        var positions = generatePositions(width, height, 100);

        var draw = function(positions) {
            var shapes = drawDiagram(svg, positions, width, height);
            var newPositions = movePositions(positions, width, height);
            var redraw = function() {
                shapes.circles.remove();
                shapes.paths.remove();
                draw(newPositions);
            };
            //setTimeout(redraw, 1000);
        };

        draw(positions);


    </script>
  </body>
</html>
